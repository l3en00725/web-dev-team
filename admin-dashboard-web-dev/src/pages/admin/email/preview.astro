---
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { sendAdminInvitationEmail } from '../../../lib/form-email';

// Auth handled by Clerk middleware
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in', 302);
}
const user = await Astro.locals.currentUser();
const adminEmail = user?.primaryEmailAddress?.emailAddress;

// Get preview type from query params
const previewType = Astro.url.searchParams.get('type') || 'admin-invitation';

// Helper function to get admin invitation email HTML
async function getAdminInvitationPreview() {
  const roleLabels: Record<string, string> = {
    'super_admin': 'Super Admin (Full Access)',
    'content_manager': 'Content Manager',
    'viewer': 'Viewer (Read-only)'
  };

  const roleDescription: Record<string, string> = {
    'super_admin': 'Full system access with all capabilities including user management, social account connections, and system configuration.',
    'content_manager': 'Content creation and publishing permissions. Can manage email campaigns and view donor data.',
    'viewer': 'Read-only access for viewing dashboard, reports, donor data, and event registrations.'
  };

  const sampleData = {
    name: 'Benjamin Haberman',
    email: 'ben@example.com',
    role: 'content_manager',
    invitedBy: 'Ben'
  };

  const colors = {
    primary: '#0ea5e9',
    primaryDark: '#0369a1',
    primaryLight: '#e0f2fe',
    primarySurface: '#f0f9ff',
    accent: '#f59e0b',
    textPrimary: '#0c4a6e',
    textSecondary: '#475569',
    white: '#ffffff',
    slate900: '#0f172a',
    slate600: '#475569',
    slate700: '#334155',
    amber50: '#fffbeb',
    amber100: '#fef3c7',
    amber900: '#78350f',
    skyLight: '#f0f9ff',
    skyBlue: '#e0f2fe'
  };

  return `<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; padding: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; line-height: 1.6; color: ${colors.slate600}; background: ${colors.white}; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .email-wrapper { padding: 40px 20px; background: ${colors.white}; }
      .container { max-width: 600px; margin: 0 auto; }
      .card { background: ${colors.white}; border: 2px solid ${colors.primaryLight}; border-radius: 24px; padding: 32px; text-align: center; }
      .header { margin-bottom: 32px; }
      .logo-area { margin-bottom: 24px; }
      h1 { font-family: 'Outfit', sans-serif; font-size: 32px; font-weight: 800; color: ${colors.slate900}; margin: 0 0 16px 0; line-height: 1.2; letter-spacing: -0.02em; }
      .welcome-text { font-size: 16px; color: ${colors.slate600}; margin: 0 0 32px 0; line-height: 1.75; }
      .role-box { background: ${colors.skyLight}; border: 1px solid ${colors.skyBlue}; border-radius: 16px; padding: 24px; margin: 32px 0; text-align: left; display: flex; align-items: flex-start; gap: 16px; }
      .role-icon { width: 48px; height: 48px; background: ${colors.primary}; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
      .role-content { flex: 1; }
      .role-title { font-family: 'Outfit', sans-serif; font-size: 18px; font-weight: 600; color: ${colors.slate700}; margin: 0 0 8px 0; }
      .role-description { font-size: 14px; color: ${colors.slate600}; margin: 0; line-height: 1.6; }
      .instructions { text-align: left; margin: 32px 0; padding-left: 0; list-style: none; counter-reset: step-counter; }
      .instructions li { margin: 16px 0; padding-left: 40px; position: relative; font-size: 16px; color: ${colors.slate700}; line-height: 1.6; }
      .instructions li:before { content: counter(step-counter); counter-increment: step-counter; position: absolute; left: 0; width: 24px; height: 24px; background: ${colors.primary}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; font-family: 'Outfit', sans-serif; }
      .email-highlight { color: ${colors.primaryDark}; font-weight: 600; text-decoration: none; }
      .cta-button { display: block; width: 100%; padding: 16px 32px; background: ${colors.primary}; color: ${colors.white}; text-decoration: none; border-radius: 12px; border-bottom: 4px solid ${colors.primaryDark}; font-size: 18px; font-weight: 700; font-family: 'Outfit', sans-serif; text-align: center; margin: 32px 0; cursor: pointer; transition: filter 0.2s ease; }
      .cta-button:hover { filter: brightness(110%); }
      .cta-button:active { border-bottom: 2px solid ${colors.primaryDark}; padding-top: 18px; padding-bottom: 14px; }
      .note { margin-top: 32px; padding: 20px; background: ${colors.amber50}; border: 1px solid ${colors.amber100}; border-radius: 12px; text-align: left; font-size: 14px; color: ${colors.amber900}; line-height: 1.75; }
      .note strong { color: ${colors.amber900}; font-weight: 600; }
      .footer { margin-top: 40px; padding-top: 24px; border-top: 1px solid ${colors.primaryLight}; text-align: center; font-size: 12px; color: ${colors.slate600}; }
      @media only screen and (max-width: 600px) { .card { padding: 24px; border-radius: 20px; } h1 { font-size: 28px; } .welcome-text { font-size: 16px; } .role-box { flex-direction: column; text-align: center; } }
    </style>
  </head>
  <body>
    <div class="email-wrapper">
      <div class="container">
        <div class="card">
          <div class="logo-area"><div style="font-size: 48px; color: ${colors.primary}; margin-bottom: 8px;">ðŸ‘‹</div></div>
          <div class="header">
            <h1>Welcome to The Blue Kids Admin Dashboard</h1>
            <p class="welcome-text">Hi ${sampleData.name}, you've been invited to access the platform by ${sampleData.invitedBy}. Let's get you settled in.</p>
          </div>
          <div class="role-box">
            <div class="role-icon"><span style="color: white; font-size: 24px;">ðŸŽ¯</span></div>
            <div class="role-content">
              <div class="role-title">Your Role: ${roleLabels[sampleData.role] || sampleData.role}</div>
              <p class="role-description">${roleDescription[sampleData.role] || 'Access to admin dashboard'}</p>
            </div>
          </div>
          <div style="text-align: left; margin: 32px 0;">
            <p style="font-weight: 600; color: ${colors.textPrimary}; margin-bottom: 16px; font-size: 16px;">To get started:</p>
            <ol class="instructions">
              <li>Visit the admin sign-in page using the button below</li>
              <li>Sign in with your email: <a href="mailto:${sampleData.email}" class="email-highlight">${sampleData.email}</a></li>
              <li>If this is your first time, you'll need to create a Supabase account with this email address</li>
            </ol>
          </div>
          <a href="https://thebluekids.com/sign-in" class="cta-button">Sign In to Admin Dashboard</a>
          <div class="note">
            <strong>Note:</strong> You must sign in using Supabase authentication with the email address <strong>${sampleData.email}</strong>. If you don't have a Supabase account yet, you can create one during the sign-in process.
          </div>
          <div class="footer">
            <p style="margin: 0 0 8px 0;"><strong>The Blue Kids Admin Dashboard</strong></p>
            <p style="margin: 0; font-size: 11px; color: ${colors.textSecondary};">This is an automated message. Please do not reply to this email.</p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>`;
}

// Helper function to get donor welcome email HTML
async function getDonorWelcomePreview() {
  const colors = {
    primary: '#0ea5e9',
    primaryDark: '#0369a1',
    skyBlue: '#e0f2fe',
    skyLight: '#f0f9ff',
    slate900: '#0f172a',
    slate600: '#475569',
    slate700: '#334155',
    amber50: '#fffbeb',
    amber100: '#fef3c7',
    amber900: '#78350f',
    white: '#ffffff',
  };

  return `<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      * { box-sizing: border-box; }
      body { 
        margin: 0; 
        padding: 0; 
        font-family: 'Inter', system-ui, -apple-system, sans-serif; 
        line-height: 1.6; 
        color: ${colors.slate600}; 
        background: ${colors.white}; 
      }
      .email-wrapper { 
        padding: 40px 20px; 
        background: ${colors.white};
      }
      .container { 
        max-width: 600px; 
        margin: 0 auto; 
      }
      /* Card Container - Hard 3D */
      .card { 
        background: ${colors.white}; 
        border: 2px solid ${colors.skyBlue}; 
        border-radius: 24px; 
        padding: 32px; 
        text-align: center; 
      }
      /* H1 Typography - Darker and tighter */
      h1 { 
        font-family: 'Outfit', sans-serif; 
        font-size: 32px; 
        font-weight: 800; 
        color: ${colors.slate900}; 
        margin: 0 0 16px 0; 
        letter-spacing: -0.02em;
        line-height: 1.2;
      }
      /* Body text - slate-600 with relaxed leading */
      .welcome-text { 
        font-size: 16px; 
        color: ${colors.slate600}; 
        margin: 0 0 32px 0; 
        line-height: 1.75;
      }
      /* Primary CTA Button - Hard Pop 3D */
      .cta-button { 
        display: block; 
        width: 100%; 
        padding: 16px 32px; 
        background: ${colors.primary};
        color: ${colors.white}; 
        text-decoration: none; 
        border-radius: 12px; 
        border-bottom: 4px solid ${colors.primaryDark};
        font-size: 18px; 
        font-weight: 700; 
        font-family: 'Outfit', sans-serif; 
        text-align: center; 
        margin: 32px 0; 
        cursor: pointer;
        transition: filter 0.2s ease;
      }
      .cta-button:hover { 
        filter: brightness(110%);
      }
      .cta-button:active { 
        border-bottom: 2px solid ${colors.primaryDark};
        padding-top: 18px;
        padding-bottom: 14px;
      }
      /* Role Box - Clean blue container */
      .role-box {
        background: ${colors.skyLight};
        border: 1px solid ${colors.skyBlue};
        border-radius: 16px;
        padding: 24px;
        margin: 24px 0;
        text-align: left;
      }
      .role-title {
        font-family: 'Outfit', sans-serif;
        font-size: 16px;
        font-weight: 600;
        color: ${colors.slate700};
        margin: 0 0 8px 0;
      }
      .role-description {
        font-size: 14px;
        color: ${colors.slate600};
        margin: 0;
        line-height: 1.6;
      }
      /* Note Box - Soft amber container (no aggressive border) */
      .note { 
        margin-top: 32px; 
        padding: 20px; 
        background: ${colors.amber50}; 
        border: 1px solid ${colors.amber100};
        border-radius: 12px; 
        text-align: left; 
        font-size: 14px; 
        color: ${colors.amber900}; 
        line-height: 1.75;
      }
      .note strong { 
        color: ${colors.amber900}; 
        font-weight: 600; 
      }
      @media only screen and (max-width: 600px) { 
        .card { 
          padding: 32px 24px; 
          border-radius: 16px; 
        } 
        h1 { 
          font-size: 28px; 
        } 
      }
    </style>
  </head>
  <body>
    <div class="email-wrapper">
      <div class="container">
        <div class="card">
          <div style="font-size: 48px; color: ${colors.primary}; margin-bottom: 24px;">ðŸŽ‰</div>
          <h1>Thank You for Your Generous Gift!</h1>
          <p class="welcome-text">Dear John Doe, your support means the world to us and the kids we serve. Your donation helps us provide free sports instruction to children in Cape May County who might not otherwise have access to these opportunities.</p>
          
          <div class="role-box">
            <div class="role-title">Your Impact</div>
            <p class="role-description">Thanks to generous donors like you, we're able to offer free coaching, equipment, and positive mentorship to kids throughout Cape May County. Every donation directly supports our programs and helps build confidence, teamwork, and healthy habits in our community's youth.</p>
          </div>
          
          <a href="https://thebluekids.com/programs" class="cta-button">See Our Programs in Action</a>
          
          <div class="note">
            <strong>Tax Receipt:</strong> A receipt for your donation has been sent to your email address for tax purposes. If you have any questions about your donation or our programs, please don't hesitate to contact us at info@thebluekids.com.
          </div>
        </div>
      </div>
    </div>
  </body>
</html>`;
}

// Generate preview HTML based on type
const previewHTML = previewType === 'admin-invitation' 
  ? await getAdminInvitationPreview() 
  : await getDonorWelcomePreview();
---

<AdminLayout title="Email Previews | Admin Dashboard" userId={userId} email={adminEmail}>
  <div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-4xl md:text-5xl font-display font-black text-brand-primary mb-2">
        Email Previews
      </h1>
      <p class="text-xl text-brand-primary/70 font-body">
        Preview how emails look before sending them to users and donors
      </p>
    </div>

    <!-- Email Type Selector -->
    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-lg border border-brand-primary/10 mb-8">
      <div class="flex gap-4 mb-6">
        <a
          href="/admin/email/preview?type=admin-invitation"
          class={`px-6 py-3 rounded-full font-bold transition-colors ${
            previewType === 'admin-invitation'
              ? 'bg-brand-primary text-white'
              : 'bg-brand-light text-brand-primary hover:bg-brand-primary/10'
          }`}
        >
          Admin Invitation
        </a>
        <a
          href="/admin/email/preview?type=donor-welcome"
          class={`px-6 py-3 rounded-full font-bold transition-colors ${
            previewType === 'donor-welcome'
              ? 'bg-brand-primary text-white'
              : 'bg-brand-light text-brand-primary hover:bg-brand-primary/10'
          }`}
        >
          Donor Welcome
        </a>
      </div>

      <!-- Preview Container -->
      <div class="border-2 border-brand-primary/20 rounded-2xl overflow-hidden bg-gray-100">
        <div class="bg-white border-b border-brand-primary/20 p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
            <span class="ml-4 text-sm text-brand-primary/70 font-mono">
              Email Preview - {previewType === 'admin-invitation' ? 'Admin Invitation' : 'Donor Welcome'}
            </span>
          </div>
          <button
            onclick="window.print()"
            class="px-4 py-2 bg-brand-primary text-white rounded-lg text-sm font-semibold hover:bg-brand-dark transition-colors"
          >
            Print Preview
          </button>
        </div>
        
        <div class="bg-white p-8 overflow-auto" style="max-height: 80vh;">
          <iframe
            id="email-preview-iframe"
            srcdoc={previewHTML}
            style="width: 100%; min-height: 600px; border: none;"
            title="Email Preview"
          ></iframe>
        </div>
      </div>

      <!-- Preview Info -->
      <div class="mt-6 p-4 bg-brand-light rounded-xl border border-brand-primary/10">
        <h3 class="font-semibold text-brand-primary mb-2">Preview Information</h3>
        <ul class="text-sm text-brand-primary/70 space-y-1">
          {previewType === 'admin-invitation' ? (
            <>
              <li>â€¢ This email is sent automatically when a new admin user is added</li>
              <li>â€¢ Includes role information and sign-in instructions</li>
              <li>â€¢ Uses The Blue Kids design system with soft rounded geometry and blue gradients</li>
            </>
          ) : (
            <>
              <li>â€¢ This email is sent to donors after their donation is processed</li>
              <li>â€¢ Includes thank you message and information about their impact</li>
              <li>â€¢ Links to programs page so donors can see their support in action</li>
            </>
          )}
        </ul>
      </div>
    </div>
  </div>
</AdminLayout>
