---
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import SocialIcon from '../../../components/admin/SocialIcon.astro';
import { createClient } from '@supabase/supabase-js';

// Auth handled by Clerk middleware
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in', 302);
}
const user = await Astro.locals.currentUser();
const email = user?.primaryEmailAddress?.emailAddress;

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY || import.meta.env.SUPABASE_SERVICE_KEY
);

// Get user's role
const { data: adminUser } = await supabase
  .from('admin_users')
  .select('role')
  .eq('user_id', userId)
  .single();

const userRole = adminUser?.role || 'viewer';
const canConnect = ['super_admin', 'content_manager'].includes(userRole);

// Get accessible social accounts
const { data: accounts } = await supabase
  .from('social_connections')
  .select('*')
  .eq('active', true)
  .or(`user_id.eq.${userId},ownership.eq.org`)
  .order('ownership', { ascending: false })
  .order('connected_at', { ascending: false });

// Platform display info
const platformInfo: Record<string, { name: string; charLimit: number }> = {
  linkedin: { name: 'LinkedIn', charLimit: 3000 },
  x: { name: 'X (Twitter)', charLimit: 280 },
  facebook: { name: 'Facebook', charLimit: 63206 },
  instagram: { name: 'Instagram', charLimit: 2200 },
  threads: { name: 'Threads', charLimit: 500 },
  tiktok: { name: 'TikTok', charLimit: 2200 },
  youtube: { name: 'YouTube', charLimit: 5000 },
  pinterest: { name: 'Pinterest', charLimit: 500 },
  reddit: { name: 'Reddit', charLimit: 40000 },
  bluesky: { name: 'Bluesky', charLimit: 300 },
  medium: { name: 'Medium', charLimit: 0 },
};

// Check if Upload-Post is configured
const uploadPostConfigured = !!import.meta.env.UPLOAD_POST_API_KEY;

// Check if Claude AI is configured
const claudeConfigured = !!import.meta.env.ANTHROPIC_API_KEY;
---

<AdminLayout title="Compose Post | Social Publishing" userId={userId} email={email}>
  <div class="max-w-5xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-4xl md:text-5xl font-display font-black text-brand-primary mb-2">
        Compose Post
      </h1>
      <p class="text-xl text-brand-primary/70 font-body">
        Create and publish content across your social platforms
      </p>
      
      {!uploadPostConfigured && (
        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl text-yellow-800">
          <strong>Warning:</strong> Upload-Post API key not configured. Add <code>UPLOAD_POST_API_KEY</code> to your environment variables.
        </div>
      )}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Compose Area -->
      <div class="lg:col-span-2 space-y-6">
        <!-- AI Content Generator -->
        {claudeConfigured && (
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-3xl p-6 shadow-lg border border-purple-200">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-2xl">ü§ñ</span>
              <h3 class="text-lg font-display font-bold text-brand-primary">AI Content Generator</h3>
              <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">Claude AI</span>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-brand-primary font-semibold mb-2">What do you want to post about?</label>
                <textarea
                  id="ai-prompt"
                  placeholder="e.g., Our upcoming basketball clinic on Feb 28th, or thanking our donors for their support..."
                  rows="2"
                  class="w-full px-4 py-3 rounded-xl border border-purple-200 text-brand-primary focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
                ></textarea>
              </div>
              <div class="flex flex-wrap gap-3">
                <div class="flex items-center gap-2">
                  <label class="text-sm text-brand-primary">Tone:</label>
                  <select id="ai-tone" class="px-3 py-1.5 rounded-lg border border-purple-200 text-sm text-brand-primary focus:outline-none focus:ring-2 focus:ring-purple-400">
                    <option value="inspiring">Inspiring</option>
                    <option value="professional">Professional</option>
                    <option value="casual">Casual</option>
                    <option value="urgent">Urgent</option>
                    <option value="grateful">Grateful</option>
                  </select>
                </div>
                <label class="flex items-center gap-2 text-sm text-brand-primary">
                  <input type="checkbox" id="ai-emojis" checked class="w-4 h-4 rounded border-purple-200 text-purple-600 focus:ring-purple-400" />
                  Include emojis
                </label>
                <label class="flex items-center gap-2 text-sm text-brand-primary">
                  <input type="checkbox" id="ai-hashtags" checked class="w-4 h-4 rounded border-purple-200 text-purple-600 focus:ring-purple-400" />
                  Include hashtags
                </label>
              </div>
              <button
                id="generate-ai-btn"
                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl font-semibold hover:from-purple-700 hover:to-blue-700 transition-all flex items-center gap-2"
              >
                <span>‚ú®</span> Generate with Claude
              </button>
            </div>
          </div>
        )}

        <!-- Text Content -->
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10">
          <div class="flex items-center justify-between mb-3">
            <label class="block text-brand-primary font-semibold">Post Content</label>
            {claudeConfigured && (
              <span id="ai-generated-badge" class="hidden px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">
                AI Generated
              </span>
            )}
          </div>
          <textarea
            id="post-content"
            placeholder="What would you like to share? Use the AI generator above for inspiration!"
            rows="6"
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary resize-none"
          ></textarea>
          <div class="flex items-center justify-between mt-2 text-sm text-brand-primary/60">
            <span id="char-count">0 characters</span>
            <span id="platform-limits" class="hidden"></span>
          </div>
        </div>

        <!-- Media Upload -->
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10">
          <div class="flex items-center justify-between mb-3">
            <label class="block text-brand-primary font-semibold">Add Media (Optional)</label>
            <span id="media-count" class="text-sm text-brand-primary/60">0 files</span>
          </div>
          
          <!-- Upload Area -->
          <div 
            id="upload-dropzone"
            class="border-2 border-dashed border-brand-primary/30 rounded-xl p-8 text-center hover:border-brand-primary/50 transition-colors cursor-pointer"
          >
            <input 
              type="file" 
              id="media-input" 
              multiple 
              accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/quicktime,video/webm,video/mpeg"
              class="hidden"
            />
            <div class="text-4xl mb-3">üì∑</div>
            <p class="text-brand-primary font-semibold mb-1">Drop files here or click to upload</p>
            <p class="text-sm text-brand-primary/60">
              Images: JPEG, PNG, GIF, WebP (max 10MB) | Videos: MP4, MOV, WebM (max 100MB)
            </p>
          </div>

          <!-- Upload Progress -->
          <div id="upload-progress" class="hidden mt-4">
            <div class="flex items-center gap-3">
              <div class="flex-1 h-2 bg-brand-light rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-brand-primary transition-all duration-300" style="width: 0%"></div>
              </div>
              <span id="progress-text" class="text-sm text-brand-primary/60">0%</span>
            </div>
          </div>

          <!-- Media Preview Grid -->
          <div id="media-preview" class="hidden mt-4 grid grid-cols-2 md:grid-cols-3 gap-3">
            <!-- Media items will be inserted here -->
          </div>

          <!-- Media Type Info -->
          <div id="media-type-info" class="hidden mt-4 p-3 bg-brand-light rounded-xl">
            <div class="flex items-center gap-2 text-sm">
              <span id="media-type-icon">üì∑</span>
              <span id="media-type-text" class="text-brand-primary"></span>
            </div>
          </div>
        </div>

        <!-- Link Preview -->
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10">
          <label class="block text-brand-primary font-semibold mb-3">Add Link (Optional)</label>
          <div class="flex gap-3">
            <input
              type="url"
              id="link-url"
              placeholder="https://example.com/article"
              class="flex-1 px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
            <button
              id="fetch-preview-btn"
              class="px-4 py-3 bg-brand-primary text-white rounded-xl font-semibold hover:bg-brand-dark transition-colors"
            >
              Preview
            </button>
          </div>
          
          <!-- OG Preview Card -->
          <div id="link-preview" class="hidden mt-4 border border-brand-primary/20 rounded-xl overflow-hidden">
            <div id="preview-image" class="h-40 bg-brand-light bg-cover bg-center"></div>
            <div class="p-4">
              <div id="preview-site" class="text-xs text-brand-primary/60 uppercase tracking-wide"></div>
              <div id="preview-title" class="font-semibold text-brand-primary mt-1"></div>
              <div id="preview-description" class="text-sm text-brand-primary/70 mt-1 line-clamp-2"></div>
            </div>
          </div>
        </div>

        <!-- Schedule -->
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10">
          <label class="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" id="schedule-toggle" class="w-5 h-5 rounded border-brand-primary/20 text-brand-primary focus:ring-brand-primary" />
            <span class="text-brand-primary font-semibold">Schedule for later</span>
          </label>
          <div id="schedule-options" class="hidden mt-4">
            <input
              type="datetime-local"
              id="scheduled-at"
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
        </div>
      </div>

      <!-- Sidebar: Platform Selection & Actions -->
      <div class="space-y-6">
        <!-- Platform Selection -->
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10">
          <h3 class="text-lg font-display font-bold text-brand-primary mb-4">Publish To</h3>
          
          {accounts && accounts.length > 0 ? (
            <div class="space-y-3">
              {accounts.map((account) => {
                const info = platformInfo[account.platform] || { name: account.platform, charLimit: 0 };
                return (
                  <label class="flex items-center gap-3 p-3 border border-brand-primary/10 rounded-xl cursor-pointer hover:bg-brand-light transition-colors account-option">
                    <input
                      type="checkbox"
                      name="accounts"
                      value={account.id}
                      data-platform={account.platform}
                      data-char-limit={info.charLimit}
                      class="w-5 h-5 rounded border-brand-primary/20 text-brand-primary focus:ring-brand-primary"
                    />
                    <SocialIcon platform={account.platform} size={24} />
                    <div class="flex-1">
                      <div class="font-semibold text-brand-primary">{info.name}</div>
                      {account.platform_username && (
                        <div class="text-xs text-brand-primary/60">@{account.platform_username}</div>
                      )}
                      {account.ownership === 'org' && (
                        <span class="inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">Org</span>
                      )}
                    </div>
                  </label>
                );
              })}
            </div>
          ) : (
            <div class="text-center py-6">
              <p class="text-brand-primary/60 mb-4">No social accounts connected</p>
              {canConnect && (
                <a
                  href="/admin/social/connections"
                  class="inline-block px-4 py-2 bg-brand-primary text-white rounded-xl font-semibold hover:bg-brand-dark transition-colors text-sm"
                >
                  Connect Accounts
                </a>
              )}
            </div>
          )}
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10 space-y-3">
          <button
            id="save-draft-btn"
            class="w-full px-4 py-3 border-2 border-brand-primary text-brand-primary rounded-xl font-semibold hover:bg-brand-light transition-colors"
          >
            Save as Draft
          </button>
          <button
            id="publish-btn"
            class="w-full px-4 py-3 bg-brand-primary text-white rounded-xl font-semibold hover:bg-brand-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled={!uploadPostConfigured || !accounts || accounts.length === 0}
          >
            Publish Now
          </button>
        </div>

        <!-- Status Message -->
        <div id="status-message" class="hidden p-4 rounded-xl text-center"></div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  const postContent = document.getElementById('post-content') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count');
  const platformLimits = document.getElementById('platform-limits');
  const linkUrl = document.getElementById('link-url') as HTMLInputElement;
  const fetchPreviewBtn = document.getElementById('fetch-preview-btn');
  const linkPreview = document.getElementById('link-preview');
  const previewImage = document.getElementById('preview-image');
  const previewSite = document.getElementById('preview-site');
  const previewTitle = document.getElementById('preview-title');
  const previewDescription = document.getElementById('preview-description');
  const scheduleToggle = document.getElementById('schedule-toggle') as HTMLInputElement;
  const scheduleOptions = document.getElementById('schedule-options');
  const scheduledAt = document.getElementById('scheduled-at') as HTMLInputElement;
  const saveDraftBtn = document.getElementById('save-draft-btn');
  const publishBtn = document.getElementById('publish-btn');
  const statusMessage = document.getElementById('status-message');
  const accountCheckboxes = document.querySelectorAll('input[name="accounts"]') as NodeListOf<HTMLInputElement>;

  // AI Generation elements
  const aiPrompt = document.getElementById('ai-prompt') as HTMLTextAreaElement;
  const aiTone = document.getElementById('ai-tone') as HTMLSelectElement;
  const aiEmojis = document.getElementById('ai-emojis') as HTMLInputElement;
  const aiHashtags = document.getElementById('ai-hashtags') as HTMLInputElement;
  const generateAiBtn = document.getElementById('generate-ai-btn');
  const aiGeneratedBadge = document.getElementById('ai-generated-badge');

  // Media upload elements
  const uploadDropzone = document.getElementById('upload-dropzone');
  const mediaInput = document.getElementById('media-input') as HTMLInputElement;
  const uploadProgress = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const mediaPreview = document.getElementById('media-preview');
  const mediaCount = document.getElementById('media-count');
  const mediaTypeInfo = document.getElementById('media-type-info');
  const mediaTypeIcon = document.getElementById('media-type-icon');
  const mediaTypeText = document.getElementById('media-type-text');

  // Store uploaded media
  interface UploadedMedia {
    name: string;
    path: string;
    url: string;
    type: 'image' | 'video';
    mimeType: string;
    size: number;
  }
  let uploadedMedia: UploadedMedia[] = [];

  // Media Upload Handling
  if (uploadDropzone && mediaInput) {
    // Click to upload
    uploadDropzone.addEventListener('click', () => mediaInput.click());

    // Drag and drop
    uploadDropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadDropzone.classList.add('border-brand-primary', 'bg-brand-light');
    });

    uploadDropzone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadDropzone.classList.remove('border-brand-primary', 'bg-brand-light');
    });

    uploadDropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadDropzone.classList.remove('border-brand-primary', 'bg-brand-light');
      const files = e.dataTransfer?.files;
      if (files && files.length > 0) {
        handleFileUpload(Array.from(files));
      }
    });

    // File input change
    mediaInput.addEventListener('change', () => {
      if (mediaInput.files && mediaInput.files.length > 0) {
        handleFileUpload(Array.from(mediaInput.files));
        mediaInput.value = ''; // Reset input
      }
    });
  }

  async function handleFileUpload(files: File[]) {
    // Check if mixing videos with images
    const hasVideo = files.some(f => f.type.startsWith('video/'));
    const hasImage = files.some(f => f.type.startsWith('image/'));
    
    if (hasVideo && files.length > 1) {
      showStatus('Video posts can only contain one video', 'error');
      return;
    }

    if (hasVideo && uploadedMedia.some(m => m.type === 'image')) {
      showStatus('Cannot mix videos with images. Remove existing media first.', 'error');
      return;
    }

    if (hasImage && uploadedMedia.some(m => m.type === 'video')) {
      showStatus('Cannot mix images with videos. Remove existing media first.', 'error');
      return;
    }

    // Show progress
    uploadProgress!.classList.remove('hidden');
    progressBar!.style.width = '0%';
    progressText!.textContent = '0%';

    const formData = new FormData();
    files.forEach(file => formData.append('files', file));

    try {
      // Simulate progress for better UX
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress = Math.min(progress + 10, 90);
        progressBar!.style.width = `${progress}%`;
        progressText!.textContent = `${progress}%`;
      }, 200);

      const response = await fetch('/api/admin/social/upload-media', {
        method: 'POST',
        body: formData,
      });

      clearInterval(progressInterval);

      const result = await response.json();

      if (response.ok && result.files) {
        progressBar!.style.width = '100%';
        progressText!.textContent = '100%';

        // Add to uploaded media
        uploadedMedia = [...uploadedMedia, ...result.files];
        updateMediaPreview();

        if (result.errors && result.errors.length > 0) {
          showStatus(`Uploaded ${result.files.length} files. Some errors: ${result.errors[0]}`, 'warning');
        } else {
          showStatus(`Uploaded ${result.files.length} file(s) successfully!`, 'success');
        }
      } else {
        showStatus(result.error || 'Failed to upload media', 'error');
      }
    } catch (error: any) {
      showStatus('Upload error: ' + error.message, 'error');
    } finally {
      setTimeout(() => {
        uploadProgress!.classList.add('hidden');
      }, 1000);
    }
  }

  function updateMediaPreview() {
    if (!mediaPreview || !mediaCount || !mediaTypeInfo) return;

    mediaCount.textContent = `${uploadedMedia.length} file${uploadedMedia.length !== 1 ? 's' : ''}`;

    if (uploadedMedia.length === 0) {
      mediaPreview.classList.add('hidden');
      mediaTypeInfo.classList.add('hidden');
      return;
    }

    mediaPreview.classList.remove('hidden');
    mediaTypeInfo.classList.remove('hidden');

    // Update media type info
    const hasVideo = uploadedMedia.some(m => m.type === 'video');
    mediaTypeIcon!.textContent = hasVideo ? 'üé¨' : 'üì∑';
    mediaTypeText!.textContent = hasVideo 
      ? 'Video post - will be uploaded as a video to supported platforms'
      : `Photo post - ${uploadedMedia.length} image${uploadedMedia.length !== 1 ? 's' : ''} (carousel on supported platforms)`;

    // Build preview grid
    mediaPreview.innerHTML = uploadedMedia.map((media, index) => `
      <div class="relative group rounded-xl overflow-hidden bg-brand-light aspect-square">
        ${media.type === 'video' 
          ? `<video src="${media.url}" class="w-full h-full object-cover" muted></video>
             <div class="absolute inset-0 flex items-center justify-center bg-black/20">
               <span class="text-4xl">‚ñ∂Ô∏è</span>
             </div>`
          : `<img src="${media.url}" alt="${media.name}" class="w-full h-full object-cover" />`
        }
        <button
          onclick="removeMedia(${index})"
          class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-sm font-bold"
        >
          ‚úï
        </button>
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
          <p class="text-white text-xs truncate">${media.name}</p>
        </div>
      </div>
    `).join('');
  }

  async function removeMedia(index: number) {
    const media = uploadedMedia[index];
    if (!media) return;

    try {
      // Delete from storage
      await fetch('/api/admin/social/upload-media', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: media.path }),
      });

      // Remove from array
      uploadedMedia = uploadedMedia.filter((_, i) => i !== index);
      updateMediaPreview();
      showStatus('Media removed', 'success');
    } catch (error: any) {
      showStatus('Failed to remove media: ' + error.message, 'error');
    }
  }

  // Expose to window for onclick handlers
  (window as any).removeMedia = removeMedia;

  function getUploadedMediaUrls(): string[] {
    return uploadedMedia.map(m => m.url);
  }

  function getMediaType(): 'video' | 'image' | null {
    if (uploadedMedia.length === 0) return null;
    return uploadedMedia[0].type;
  }

  // AI Content Generation
  if (generateAiBtn && aiPrompt) {
    generateAiBtn.addEventListener('click', async () => {
      const prompt = aiPrompt.value.trim();
      if (!prompt) {
        showStatus('Please describe what you want to post about', 'error');
        return;
      }

      generateAiBtn.innerHTML = '<span class="animate-pulse">ü§ñ</span> Generating...';
      (generateAiBtn as HTMLButtonElement).disabled = true;

      try {
        const response = await fetch('/api/admin/social/generate-content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt,
            platforms: getSelectedPlatforms(),
            tone: aiTone?.value || 'inspiring',
            includeEmojis: aiEmojis?.checked ?? true,
            includeHashtags: aiHashtags?.checked ?? true,
          }),
        });

        const result = await response.json();

        if (response.ok && result.content) {
          postContent.value = result.content;
          updateCharCount();
          
          // Show AI generated badge
          if (aiGeneratedBadge) {
            aiGeneratedBadge.classList.remove('hidden');
          }
          
          showStatus('Content generated! Feel free to edit before posting.', 'success');
        } else {
          showStatus(result.error || 'Failed to generate content', 'error');
        }
      } catch (error: any) {
        showStatus('Error: ' + error.message, 'error');
      } finally {
        generateAiBtn.innerHTML = '<span>‚ú®</span> Generate with Claude';
        (generateAiBtn as HTMLButtonElement).disabled = false;
      }
    });
  }

  // Hide AI badge when user manually edits
  if (postContent && aiGeneratedBadge) {
    postContent.addEventListener('input', () => {
      // Keep badge visible but could add logic to hide it on significant edits
    });
  }

  // Platform character limits
  const platformCharLimits: Record<string, number> = {
    linkedin: 3000,
    x: 280,
    facebook: 63206,
    instagram: 2200,
    threads: 500,
    tiktok: 2200,
    youtube: 5000,
    pinterest: 500,
    reddit: 40000,
    bluesky: 300,
  };

  // Character count
  if (postContent && charCount) {
    postContent.addEventListener('input', updateCharCount);
  }

  function updateCharCount() {
    const length = postContent.value.length;
    charCount!.textContent = `${length} characters`;
    
    // Check against selected platforms
    const selectedPlatforms = getSelectedPlatforms();
    if (selectedPlatforms.length > 0) {
      const warnings: string[] = [];
      selectedPlatforms.forEach(platform => {
        const limit = platformCharLimits[platform];
        if (limit && length > limit) {
          warnings.push(`${platform}: ${length}/${limit}`);
        }
      });
      if (warnings.length > 0) {
        platformLimits!.textContent = warnings.join(' | ');
        platformLimits!.classList.remove('hidden');
        platformLimits!.classList.add('text-red-500');
      } else {
        platformLimits!.classList.add('hidden');
      }
    }
  }

  function getSelectedPlatforms(): string[] {
    const platforms: string[] = [];
    accountCheckboxes.forEach(cb => {
      if (cb.checked) {
        platforms.push(cb.dataset.platform || '');
      }
    });
    return platforms.filter(Boolean);
  }

  function getSelectedAccountIds(): string[] {
    const ids: string[] = [];
    accountCheckboxes.forEach(cb => {
      if (cb.checked) {
        ids.push(cb.value);
      }
    });
    return ids;
  }

  // Account selection change
  accountCheckboxes.forEach(cb => {
    cb.addEventListener('change', updateCharCount);
  });

  // Schedule toggle
  if (scheduleToggle && scheduleOptions) {
    scheduleToggle.addEventListener('change', () => {
      if (scheduleToggle.checked) {
        scheduleOptions.classList.remove('hidden');
        // Set default to 1 hour from now
        const defaultDate = new Date(Date.now() + 60 * 60 * 1000);
        scheduledAt.value = defaultDate.toISOString().slice(0, 16);
      } else {
        scheduleOptions.classList.add('hidden');
        scheduledAt.value = '';
      }
    });
  }

  // Link preview
  if (fetchPreviewBtn && linkUrl) {
    fetchPreviewBtn.addEventListener('click', async () => {
      const url = linkUrl.value.trim();
      if (!url) return;

      fetchPreviewBtn.textContent = 'Loading...';
      fetchPreviewBtn.setAttribute('disabled', 'true');

      try {
        const response = await fetch(`/api/og-preview?url=${encodeURIComponent(url)}`);
        const data = await response.json();

        if (response.ok && data.title) {
          linkPreview!.classList.remove('hidden');
          if (data.image) {
            previewImage!.style.backgroundImage = `url(${data.image})`;
            previewImage!.classList.remove('hidden');
          } else {
            previewImage!.classList.add('hidden');
          }
          previewSite!.textContent = data.siteName || new URL(url).hostname;
          previewTitle!.textContent = data.title || '';
          previewDescription!.textContent = data.description || '';
        } else {
          showStatus('Could not fetch preview for this URL', 'warning');
        }
      } catch (error) {
        showStatus('Error fetching preview', 'error');
      } finally {
        fetchPreviewBtn.textContent = 'Preview';
        fetchPreviewBtn.removeAttribute('disabled');
      }
    });
  }

  // Save draft
  if (saveDraftBtn) {
    saveDraftBtn.addEventListener('click', async () => {
      await saveDraft(false);
    });
  }

  // Publish
  if (publishBtn) {
    publishBtn.addEventListener('click', async () => {
      const selectedAccounts = getSelectedAccountIds();
      if (selectedAccounts.length === 0) {
        showStatus('Please select at least one account to publish to', 'error');
        return;
      }

      // Must have either text content or media
      if (!postContent.value.trim() && uploadedMedia.length === 0) {
        showStatus('Please enter some content or add media for your post', 'error');
        return;
      }

      // Save draft first, then publish
      const draftId = await saveDraft(true);
      if (!draftId) return;

      publishBtn.textContent = 'Publishing...';
      publishBtn.setAttribute('disabled', 'true');

      try {
        const response = await fetch('/api/admin/social/publish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ draftId }),
        });

        const result = await response.json();

        if (response.ok) {
          showStatus(result.message || 'Post published successfully!', 'success');
          // Start polling for status
          if (result.requestId) {
            pollStatus(draftId);
          }
        } else {
          showStatus(result.error || 'Failed to publish', 'error');
        }
      } catch (error: any) {
        showStatus('Error: ' + error.message, 'error');
      } finally {
        publishBtn.textContent = scheduleToggle.checked ? 'Schedule' : 'Publish Now';
        publishBtn.removeAttribute('disabled');
      }
    });
  }

  async function saveDraft(forPublish: boolean): Promise<string | null> {
    const selectedAccounts = getSelectedAccountIds();
    const selectedPlatforms = getSelectedPlatforms();

    const data = {
      textContent: postContent.value || null,
      mediaUrls: getUploadedMediaUrls(),
      linkUrl: linkUrl.value.trim() || null,
      targetPlatforms: selectedPlatforms,
      targetAccounts: selectedAccounts,
      scheduledAt: scheduleToggle.checked ? scheduledAt.value : null,
    };

    if (!forPublish) {
      saveDraftBtn!.textContent = 'Saving...';
      saveDraftBtn!.setAttribute('disabled', 'true');
    }

    try {
      const response = await fetch('/api/admin/social/drafts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        if (!forPublish) {
          showStatus('Draft saved successfully!', 'success');
        }
        return result.draft.id;
      } else {
        showStatus(result.error || 'Failed to save draft', 'error');
        return null;
      }
    } catch (error: any) {
      showStatus('Error: ' + error.message, 'error');
      return null;
    } finally {
      if (!forPublish) {
        saveDraftBtn!.textContent = 'Save as Draft';
        saveDraftBtn!.removeAttribute('disabled');
      }
    }
  }

  async function pollStatus(draftId: string) {
    let attempts = 0;
    const maxAttempts = 30; // 5 minutes with 10s intervals

    const poll = async () => {
      try {
        const response = await fetch(`/api/admin/social/status/${draftId}`);
        const data = await response.json();

        if (data.status === 'published') {
          showStatus('Post published successfully to all platforms!', 'success');
          return;
        } else if (data.status === 'partially_published') {
          showStatus('Post published to some platforms. Check results for details.', 'warning');
          return;
        } else if (data.status === 'failed') {
          showStatus('Publishing failed. Please try again.', 'error');
          return;
        }

        // Continue polling
        attempts++;
        if (attempts < maxAttempts) {
          setTimeout(poll, 10000); // Poll every 10 seconds
        }
      } catch (error) {
        console.error('Status poll error:', error);
      }
    };

    // Start polling after a short delay
    setTimeout(poll, 3000);
  }

  function showStatus(message: string, type: 'success' | 'error' | 'warning') {
    const classes = {
      success: 'bg-green-50 text-green-700 border border-green-200',
      error: 'bg-red-50 text-red-700 border border-red-200',
      warning: 'bg-yellow-50 text-yellow-700 border border-yellow-200',
    };
    
    statusMessage!.className = `p-4 rounded-xl text-center ${classes[type]}`;
    statusMessage!.textContent = message;
    statusMessage!.classList.remove('hidden');

    // Auto-hide after 5 seconds for success/warning
    if (type !== 'error') {
      setTimeout(() => {
        statusMessage!.classList.add('hidden');
      }, 5000);
    }
  }

  // Update publish button text based on schedule
  if (scheduleToggle && publishBtn) {
    scheduleToggle.addEventListener('change', () => {
      publishBtn.textContent = scheduleToggle.checked ? 'Schedule' : 'Publish Now';
    });
  }
</script>
