---
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { createClient } from '@supabase/supabase-js';

// Auth handled by Clerk middleware
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in', 302);
}
const user = await Astro.locals.currentUser();
const email = user?.primaryEmailAddress?.emailAddress;

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY || import.meta.env.SUPABASE_SERVICE_KEY
);

// Fetch all events
const { data: events } = await supabase
  .from('programs')
  .select('*')
  .order('event_date', { ascending: false })
  .limit(100);

// Get registration counts and registrants for each event
const eventsWithRegistrants = await Promise.all(
  (events || []).map(async (event) => {
    const { data: registrations, count } = await supabase
      .from('event_registrations')
      .select('*')
      .eq('program_id', event.id)
      .order('created_at', { ascending: false });
    
    return {
      ...event,
      registrationCount: count || 0,
      registrations: registrations || [],
    };
  })
);
---

<AdminLayout title="Events | Admin Dashboard" userId={userId} email={email}>
  <div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-4xl md:text-5xl font-display font-black text-brand-primary mb-2">
          Events
        </h1>
        <p class="text-xl text-brand-primary/70 font-body">
          Manage sports events and registrations
        </p>
      </div>
      <a
        href="/admin/events/create"
        class="px-6 py-3 bg-brand-primary text-white rounded-full font-bold hover:bg-brand-dark transition-colors"
      >
        ➕ Create New Event
      </a>
    </div>

    <!-- Events List with Registrants -->
    <div class="space-y-6">
      {eventsWithRegistrants && eventsWithRegistrants.length > 0 ? (
        eventsWithRegistrants.map((event) => (
          <div class="bg-white rounded-3xl shadow-lg border border-brand-primary/10 overflow-hidden">
            <!-- Event Header -->
            <div class="p-6 border-b border-brand-primary/10">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-4 mb-3">
                    <span class="px-4 py-2 bg-brand-accent/20 text-brand-accent rounded-full text-sm font-semibold">
                      {event.sport}
                    </span>
                    <span class={`px-3 py-1 rounded-full text-xs font-semibold ${
                      event.status === 'upcoming' ? 'bg-blue-100 text-blue-700' :
                      event.status === 'completed' ? 'bg-green-100 text-green-700' :
                      'bg-gray-100 text-gray-700'
                    }`}>
                      {event.status}
                    </span>
                  </div>
                  <h3 class="text-2xl font-display font-black text-brand-primary mb-2">
                    {new Date(event.event_date).toLocaleDateString('en-US', { 
                      weekday: 'long', 
                      month: 'long', 
                      day: 'numeric', 
                      year: 'numeric' 
                    })} at {new Date(event.event_date).toLocaleTimeString('en-US', { 
                      hour: 'numeric', 
                      minute: '2-digit' 
                    })}
                  </h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-brand-primary/70">
                    <div>
                      <strong class="text-brand-primary">Location:</strong> {event.location || 'TBA'}
                    </div>
                    {event.coach_name && (
                      <div>
                        <strong class="text-brand-primary">Event Leader:</strong> {event.coach_name}
                      </div>
                    )}
                  </div>
                  {event.description && (
                    <p class="mt-3 text-brand-primary/80">{event.description}</p>
                  )}
                </div>
                <div class="flex flex-col items-end gap-2 ml-4">
                  <div class="text-right">
                    <div class="text-3xl font-display font-black text-brand-primary">
                      {event.registrationCount}
                    </div>
                    <div class="text-sm text-brand-primary/70">
                      {event.max_participants ? `of ${event.max_participants}` : ''} Registrations
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <a
                      href={`/admin/events/${event.id}/edit`}
                      class="px-4 py-2 border-2 border-brand-primary text-brand-primary rounded-full font-semibold hover:bg-brand-light transition-colors text-sm"
                    >
                      Edit
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Registrants Section -->
            <div class="border-t border-brand-primary/10">
              <button
                onclick={`toggleRegistrants('${event.id}')`}
                class="w-full px-6 py-4 flex items-center justify-between hover:bg-brand-light/50 transition-colors"
              >
                <span class="font-semibold text-brand-primary">
                  View Registrants ({event.registrationCount})
                </span>
                <span id={`icon-${event.id}`} class="text-brand-primary">▼</span>
              </button>
              <div id={`registrants-${event.id}`} class="hidden border-t border-brand-primary/10">
                {event.registrations && event.registrations.length > 0 ? (
                  <div class="p-6">
                    <div class="overflow-x-auto">
                      <table class="min-w-full">
                        <thead>
                          <tr class="border-b border-brand-primary/10">
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Child Name</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Age</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Parent Name</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Parent Email</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Parent Phone</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Status</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Registered</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-brand-primary uppercase">Notes</th>
                          </tr>
                        </thead>
                        <tbody>
                          {event.registrations.map((reg: any) => (
                            <tr class="border-b border-brand-primary/5 hover:bg-brand-light/30">
                              <td class="py-3 px-4 font-semibold text-brand-primary">
                                {reg.child_first_name}
                              </td>
                              <td class="py-3 px-4 text-sm text-brand-primary/80">
                                {reg.child_age}
                              </td>
                              <td class="py-3 px-4 text-sm text-brand-primary/80">
                                {reg.parent_name}
                              </td>
                              <td class="py-3 px-4 text-sm text-brand-primary/80">
                                <a href={`mailto:${reg.parent_email}`} class="text-brand-accent hover:underline">
                                  {reg.parent_email}
                                </a>
                              </td>
                              <td class="py-3 px-4 text-sm text-brand-primary/80">
                                {reg.parent_phone ? (
                                  <a href={`tel:${reg.parent_phone}`} class="text-brand-accent hover:underline">
                                    {reg.parent_phone}
                                  </a>
                                ) : (
                                  '-'
                                )}
                              </td>
                              <td class="py-3 px-4">
                                <span class={`px-2 py-1 rounded-full text-xs font-semibold ${
                                  reg.status === 'registered' ? 'bg-blue-100 text-blue-700' :
                                  reg.status === 'confirmed' ? 'bg-green-100 text-green-700' :
                                  reg.status === 'attended' ? 'bg-purple-100 text-purple-700' :
                                  reg.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {reg.status}
                                </span>
                              </td>
                              <td class="py-3 px-4 text-xs text-brand-primary/60">
                                {new Date(reg.created_at).toLocaleDateString('en-US', { 
                                  month: 'short', 
                                  day: 'numeric', 
                                  year: 'numeric',
                                  hour: 'numeric',
                                  minute: '2-digit'
                                })}
                              </td>
                              <td class="py-3 px-4 text-xs text-brand-primary/70 max-w-xs">
                                {reg.special_notes || '-'}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                ) : (
                  <div class="p-6 text-center text-brand-primary/70">
                    No registrations yet for this event.
                  </div>
                )}
              </div>
            </div>
          </div>
        ))
      ) : (
        <div class="bg-white rounded-3xl p-12 shadow-lg border border-brand-primary/10 text-center">
          <p class="text-brand-primary/70 mb-4">No events yet.</p>
          <a href="/admin/events/create" class="text-brand-accent hover:underline font-semibold">
            Create your first event
          </a>
        </div>
      )}
    </div>
  </div>
</AdminLayout>

<script>
  function toggleRegistrants(eventId: string) {
    const registrantsDiv = document.getElementById(`registrants-${eventId}`);
    const icon = document.getElementById(`icon-${eventId}`);
    
    if (registrantsDiv && icon) {
      if (registrantsDiv.classList.contains('hidden')) {
        registrantsDiv.classList.remove('hidden');
        icon.textContent = '▲';
      } else {
        registrantsDiv.classList.add('hidden');
        icon.textContent = '▼';
      }
    }
  }

  (window as any).toggleRegistrants = toggleRegistrants;
</script>
