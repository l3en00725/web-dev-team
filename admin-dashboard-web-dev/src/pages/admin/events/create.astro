---
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { createClient } from '@supabase/supabase-js';

// Auth handled by Clerk middleware
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in', 302);
}
const user = await Astro.locals.currentUser();
const email = user?.primaryEmailAddress?.emailAddress;

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY || import.meta.env.SUPABASE_SERVICE_KEY
);
---

<AdminLayout title="Create Event | Admin Dashboard" userId={userId} email={email}>
  <div class="max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-4xl md:text-5xl font-display font-black text-brand-primary mb-2">
        Create New Event
      </h1>
      <p class="text-xl text-brand-primary/70 font-body">
        Add a new sports event that will appear on the website and registration form
      </p>
    </div>

    <!-- Event Form -->
    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-lg border border-brand-primary/10">
      <form id="event-form" class="space-y-6">
        <!-- Sport -->
        <div>
          <label for="sport" class="block text-brand-primary font-semibold mb-2">
            Sport <span class="text-red-500">*</span>
          </label>
          <select
            id="sport"
            name="sport"
            required
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
          >
            <option value="">Select a sport</option>
            <option value="Basketball">Basketball</option>
            <option value="Soccer">Soccer</option>
            <option value="Baseball">Baseball</option>
          </select>
        </div>

        <!-- Event Date & Time -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="event-date" class="block text-brand-primary font-semibold mb-2">
              Event Date <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              id="event-date"
              name="eventDate"
              required
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
          <div>
            <label for="event-time" class="block text-brand-primary font-semibold mb-2">
              Event Time <span class="text-red-500">*</span>
            </label>
            <input
              type="time"
              id="event-time"
              name="eventTime"
              required
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
        </div>

        <!-- Location -->
        <div>
          <label for="location" class="block text-brand-primary font-semibold mb-2">
            Location <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="location"
            name="location"
            required
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            placeholder="e.g., Cape May Community Center, 123 Main St, Cape May, NJ"
          />
        </div>

        <!-- Event Leader -->
        <div>
          <label for="coach-name" class="block text-brand-primary font-semibold mb-2">
            Event Leader
          </label>
          <input
            type="text"
            id="coach-name"
            name="coachName"
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            placeholder="Event leader name (optional)"
          />
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-brand-primary font-semibold mb-2">
            Event Description
          </label>
          <textarea
            id="description"
            name="description"
            rows="4"
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary resize-none"
            placeholder="Describe what kids will learn, what to bring, etc..."
          ></textarea>
        </div>

        <!-- Capacity -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="max-participants" class="block text-brand-primary font-semibold mb-2">
              Max Participants
            </label>
            <input
              type="number"
              id="max-participants"
              name="maxParticipants"
              min="1"
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
              placeholder="Leave empty for unlimited"
            />
          </div>
          <div>
            <label for="age-range" class="block text-brand-primary font-semibold mb-2">
              Age Range
            </label>
            <input
              type="text"
              id="age-range"
              name="ageRange"
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
              placeholder="e.g., Ages 6-16"
            />
          </div>
        </div>

        <!-- Status -->
        <div>
          <label for="status" class="block text-brand-primary font-semibold mb-2">
            Status <span class="text-red-500">*</span>
          </label>
          <select
            id="status"
            name="status"
            required
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
          >
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 pt-6 border-t border-brand-primary/10">
          <a
            href="/admin/events"
            class="px-6 py-3 border-2 border-brand-primary text-brand-primary rounded-full font-bold hover:bg-brand-light transition-colors"
          >
            Cancel
          </a>
          <button
            type="submit"
            id="save-btn"
            class="px-6 py-3 bg-brand-primary text-white rounded-full font-bold hover:bg-brand-dark transition-colors disabled:opacity-50"
          >
            Create Event
          </button>
        </div>
        <div id="form-message" class="hidden mt-4 p-4 rounded-xl text-center"></div>
      </form>
    </div>
  </div>
</AdminLayout>

<script>
  const eventForm = document.getElementById('event-form');
  const saveBtn = document.getElementById('save-btn');
  const formMessage = document.getElementById('form-message');

  if (eventForm && saveBtn) {
    eventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(eventForm);
      const eventDate = formData.get('eventDate');
      const eventTime = formData.get('eventTime');
      
      // Combine date and time
      const eventDateTime = eventDate && eventTime 
        ? new Date(`${eventDate}T${eventTime}`).toISOString()
        : new Date(eventDate as string).toISOString();

      const data = {
        sport: formData.get('sport'),
        eventDate: eventDateTime,
        location: formData.get('location'),
        coachName: formData.get('coachName') || null,
        description: formData.get('description') || null,
        maxParticipants: formData.get('maxParticipants') ? parseInt(formData.get('maxParticipants') as string) : null,
        status: formData.get('status'),
      };

      saveBtn.disabled = true;
      saveBtn.textContent = 'Creating...';

      try {
        const response = await fetch('/api/admin/create-event', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();
        
        if (response.ok) {
          formMessage.className = 'mt-4 p-4 rounded-xl text-center bg-green-50 text-green-700 border border-green-200';
          formMessage.textContent = 'Event created successfully! Redirecting...';
          formMessage.classList.remove('hidden');
          setTimeout(() => {
            window.location.href = '/admin/events';
          }, 1500);
        } else {
          formMessage.className = 'mt-4 p-4 rounded-xl text-center bg-red-50 text-red-700 border border-red-200';
          formMessage.textContent = result.error || 'Failed to create event';
          formMessage.classList.remove('hidden');
        }
      } catch (error: any) {
        formMessage.className = 'mt-4 p-4 rounded-xl text-center bg-red-50 text-red-700 border border-red-200';
        formMessage.textContent = 'Network error: ' + error.message;
        formMessage.classList.remove('hidden');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Create Event';
      }
    });
  }
</script>
