---
import AdminLayout from '../../../components/admin/AdminLayout.astro';
import { createClient } from '@supabase/supabase-js';

// Auth handled by Clerk middleware
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in', 302);
}
const user = await Astro.locals.currentUser();
const email = user?.primaryEmailAddress?.emailAddress;

const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY || import.meta.env.SUPABASE_SERVICE_KEY
);

// Get query parameters for filtering
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';
const tagFilter = url.searchParams.get('tag') || '';
const page = parseInt(url.searchParams.get('page') || '1');
const pageSize = 25;
const offset = (page - 1) * pageSize;

// Build query
let query = supabase
  .from('people')
  .select('*, donor_details(*)', { count: 'exact' });

// Apply search filter
if (searchQuery) {
  query = query.or(`name.ilike.%${searchQuery}%,email.ilike.%${searchQuery}%,phone.ilike.%${searchQuery}%`);
}

// Apply tag filter
if (tagFilter) {
  query = query.contains('tags', [tagFilter]);
}

// Order by last activity, then created_at
query = query
  .order('last_activity_at', { ascending: false, nullsFirst: false })
  .order('created_at', { ascending: false })
  .range(offset, offset + pageSize - 1);

const { data: people, count: totalCount, error } = await query;

// Get unique tags for filter dropdown
const { data: allPeople } = await supabase
  .from('people')
  .select('tags');

const allTags = new Set<string>();
allPeople?.forEach(p => {
  (p.tags || []).forEach((tag: string) => allTags.add(tag));
});
const uniqueTags = Array.from(allTags).sort();

// Calculate pagination
const totalPages = Math.ceil((totalCount || 0) / pageSize);

// Get quick stats
const { count: totalPeople } = await supabase.from('people').select('*', { count: 'exact', head: true });
const { count: totalDonors } = await supabase.from('donor_details').select('*', { count: 'exact', head: true });
const { count: recentActivity } = await supabase
  .from('activities')
  .select('*', { count: 'exact', head: true })
  .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
---

<AdminLayout title="People | Admin Dashboard" userId={userId} email={email}>
  <div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6 sm:mb-8">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-display font-black text-brand-primary mb-2">
        People
      </h1>
      <p class="text-base sm:text-lg md:text-xl text-brand-primary/70 font-body">
        All contacts in one place: donors, volunteers, parents, and more
      </p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div class="bg-white rounded-2xl p-5 shadow-md border border-brand-primary/10">
        <div class="text-3xl font-display font-black text-brand-primary">{totalPeople || 0}</div>
        <div class="text-sm text-brand-primary/70">Total People</div>
      </div>
      <div class="bg-white rounded-2xl p-5 shadow-md border border-brand-primary/10">
        <div class="text-3xl font-display font-black text-brand-accent">{totalDonors || 0}</div>
        <div class="text-sm text-brand-primary/70">Donors</div>
      </div>
      <div class="bg-white rounded-2xl p-5 shadow-md border border-brand-primary/10">
        <div class="text-3xl font-display font-black text-green-600">{recentActivity || 0}</div>
        <div class="text-sm text-brand-primary/70">Activities (7 days)</div>
      </div>
    </div>

    <!-- Add Person Button -->
    <div class="mb-4 sm:mb-6 flex justify-end">
      <button
        id="add-person-btn"
        class="px-4 sm:px-6 py-2 sm:py-3 bg-brand-primary text-white rounded-xl font-semibold hover:bg-brand-dark active:bg-brand-dark transition-colors flex items-center gap-2 touch-manipulation min-h-[44px] text-sm sm:text-base"
      >
        <span>+</span> <span class="hidden sm:inline">Add Person</span><span class="sm:hidden">Add</span>
      </button>
    </div>

    <!-- Add Person Modal -->
    <div id="add-person-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 safe-area-inset">
      <div class="bg-white rounded-3xl p-4 sm:p-6 md:p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto mx-4">
        <div class="flex items-center justify-between mb-4 sm:mb-6">
          <h2 class="text-xl sm:text-2xl font-display font-black text-brand-primary">Add Person</h2>
          <button id="close-add-person-modal" class="text-brand-primary/60 hover:text-brand-primary min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg hover:bg-brand-light/50 transition-colors touch-manipulation" aria-label="Close modal">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="add-person-form" class="space-y-4">
          <div>
            <label class="block text-brand-primary font-semibold mb-2">
              Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="name"
              required
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
          <div>
            <label class="block text-brand-primary font-semibold mb-2">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              name="email"
              required
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
          <div>
            <label class="block text-brand-primary font-semibold mb-2">Phone</label>
            <input
              type="tel"
              name="phone"
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
          <div>
            <label class="block text-brand-primary font-semibold mb-2">Person Type <span class="text-red-500">*</span></label>
            <select
              name="personType"
              required
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            >
              <option value="">Select type...</option>
              <option value="lead">Lead (Potential Donor)</option>
              <option value="volunteer">Volunteer</option>
              <option value="parent">Parent</option>
              <option value="partner">Partner</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-brand-primary font-semibold mb-2">Organization (Optional)</label>
            <input
              type="text"
              name="organization"
              class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
            />
          </div>
          <div id="add-person-message" class="hidden mt-4 p-4 rounded-xl text-center"></div>
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-4">
            <button
              type="button"
              id="cancel-add-person"
              class="flex-1 px-6 py-3 border-2 border-brand-primary/20 text-brand-primary rounded-xl font-semibold hover:bg-brand-light active:bg-brand-light transition-colors touch-manipulation min-h-[44px]"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-6 py-3 bg-brand-primary text-white rounded-xl font-semibold hover:bg-brand-dark active:bg-brand-dark transition-colors touch-manipulation min-h-[44px]"
            >
              Add Person
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-3xl p-6 shadow-lg border border-brand-primary/10 mb-6">
      <form method="get" class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input
            type="text"
            name="q"
            value={searchQuery}
            placeholder="Search by name, email, or phone..."
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
          />
        </div>
        <div class="w-full md:w-48">
          <select 
            name="tag"
            class="w-full px-4 py-3 rounded-xl border border-brand-primary/20 text-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
          >
            <option value="">All Tags</option>
            {uniqueTags.map(tag => (
              <option value={tag} selected={tag === tagFilter}>{tag}</option>
            ))}
          </select>
        </div>
        <button 
          type="submit"
          class="px-6 py-3 bg-brand-primary text-white rounded-xl font-semibold hover:bg-brand-dark transition-colors"
        >
          Search
        </button>
        {(searchQuery || tagFilter) && (
          <a 
            href="/admin/people"
            class="px-6 py-3 border-2 border-brand-primary/20 text-brand-primary/70 rounded-xl font-semibold hover:bg-brand-light transition-colors text-center"
          >
            Clear
          </a>
        )}
      </form>
    </div>

    <!-- Results Summary -->
    {(searchQuery || tagFilter) && (
      <div class="mb-4 text-sm text-brand-primary/70">
        Showing {people?.length || 0} of {totalCount || 0} results
        {searchQuery && <span> for "<strong>{searchQuery}</strong>"</span>}
        {tagFilter && <span> with tag <span class="px-2 py-0.5 bg-brand-light rounded-full text-xs font-semibold">{tagFilter}</span></span>}
      </div>
    )}

    <!-- People Table -->
    <div class="bg-white rounded-3xl shadow-lg border border-brand-primary/10 overflow-hidden">
      <div class="overflow-x-auto -mx-4 sm:mx-0">
        <div class="inline-block min-w-full align-middle">
          <div class="overflow-hidden">
            <table class="min-w-full divide-y divide-brand-primary/10">
          <thead class="bg-brand-light/30">
            <tr>
              <th class="text-left py-3 px-3 sm:px-6 text-xs sm:text-sm font-semibold text-brand-primary uppercase whitespace-nowrap">Person</th>
              <th class="text-left py-3 px-3 sm:px-6 text-xs sm:text-sm font-semibold text-brand-primary uppercase whitespace-nowrap hidden sm:table-cell">Contact</th>
              <th class="text-left py-3 px-3 sm:px-6 text-xs sm:text-sm font-semibold text-brand-primary uppercase whitespace-nowrap hidden md:table-cell">Tags</th>
              <th class="text-left py-3 px-3 sm:px-6 text-xs sm:text-sm font-semibold text-brand-primary uppercase whitespace-nowrap hidden lg:table-cell">Donor Status</th>
              <th class="text-left py-3 px-3 sm:px-6 text-xs sm:text-sm font-semibold text-brand-primary uppercase whitespace-nowrap hidden xl:table-cell">Last Activity</th>
              <th class="text-left py-3 px-3 sm:px-6 text-xs sm:text-sm font-semibold text-brand-primary uppercase whitespace-nowrap">Actions</th>
            </tr>
          </thead>
          <tbody>
            {people && people.length > 0 ? (
              people.map((person) => {
                const donorDetails = person.donor_details?.[0];
                return (
                  <tr class="border-b border-brand-primary/5 hover:bg-brand-light/30 transition-colors">
                    <td class="py-3 px-3 sm:px-6">
                      <div class="flex items-center gap-2 sm:gap-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-brand-primary/10 flex items-center justify-center text-brand-primary font-bold text-sm sm:text-base flex-shrink-0">
                          {person.name?.charAt(0)?.toUpperCase() || '?'}
                        </div>
                        <div class="min-w-0 flex-1">
                          <div class="font-semibold text-brand-primary text-sm sm:text-base truncate">{person.name}</div>
                          {person.organization && (
                            <div class="text-xs text-brand-primary/60 truncate">{person.organization}</div>
                          )}
                          {/* Show email on mobile in this cell */}
                          <div class="text-xs text-brand-primary/60 sm:hidden mt-1">
                            <a href={`mailto:${person.email}`} class="text-brand-accent hover:underline truncate block">
                              {person.email}
                            </a>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="py-3 px-3 sm:px-6 hidden sm:table-cell">
                      <div class="text-sm">
                        <a href={`mailto:${person.email}`} class="text-brand-accent hover:underline break-all">
                          {person.email}
                        </a>
                      </div>
                      {person.phone && (
                        <div class="text-xs text-brand-primary/60 mt-1">
                          <a href={`tel:${person.phone}`} class="hover:text-brand-accent">
                            {person.phone}
                          </a>
                        </div>
                      )}
                    </td>
                    <td class="py-3 px-3 sm:px-6 hidden md:table-cell">
                      <div class="flex flex-wrap gap-1">
                        {(person.tags || []).slice(0, 2).map((tag: string) => (
                          <a 
                            href={`/admin/people?tag=${tag}`}
                            class="px-2 py-0.5 bg-brand-light text-brand-primary/70 rounded-full text-xs font-medium hover:bg-brand-primary/10 transition-colors touch-manipulation min-h-[28px] flex items-center"
                          >
                            {tag}
                          </a>
                        ))}
                        {(person.tags || []).length > 2 && (
                          <span class="px-2 py-0.5 text-xs text-brand-primary/50">+{(person.tags || []).length - 2}</span>
                        )}
                        {(!person.tags || person.tags.length === 0) && (
                          <span class="text-brand-primary/40 text-xs">No tags</span>
                        )}
                      </div>
                    </td>
                    <td class="py-3 px-3 sm:px-6 hidden lg:table-cell">
                      {donorDetails ? (
                        <div>
                          <span class={`inline-block px-2 py-1 rounded-full text-xs font-semibold ${
                            donorDetails.status === 'vip' ? 'bg-purple-100 text-purple-700' :
                            donorDetails.status === 'recurring' ? 'bg-green-100 text-green-700' :
                            donorDetails.status === 'lapsed' ? 'bg-red-100 text-red-700' :
                            donorDetails.status === 'one-time' ? 'bg-blue-100 text-blue-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {donorDetails.status}
                          </span>
                          <div class="text-xs text-brand-primary/60 mt-1">
                            ${parseFloat(donorDetails.lifetime_total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })} lifetime
                          </div>
                        </div>
                      ) : (
                        <span class="text-brand-primary/40 text-xs">Not a donor</span>
                      )}
                    </td>
                    <td class="py-3 px-3 sm:px-6 text-xs sm:text-sm text-brand-primary/70 hidden xl:table-cell">
                      {person.last_activity_at ? (
                        new Date(person.last_activity_at).toLocaleDateString('en-US', { 
                          month: 'short', 
                          day: 'numeric', 
                          year: 'numeric' 
                        })
                      ) : (
                        <span class="text-brand-primary/40">Never</span>
                      )}
                    </td>
                    <td class="py-3 px-3 sm:px-6">
                      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
                        <a 
                          href={`/admin/people/${person.id}`}
                          class="text-brand-accent hover:text-brand-primary font-semibold text-xs sm:text-sm touch-manipulation min-h-[32px] flex items-center"
                        >
                          View â†’
                        </a>
                        <button
                          onclick={`deletePerson('${person.id}', '${person.name?.replace(/'/g, "\\'") || 'this person'}')`}
                          class="text-red-600 hover:text-red-700 font-semibold text-xs sm:text-sm touch-manipulation min-h-[32px] flex items-center"
                        >
                          Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr>
                <td colspan="6" class="py-12 text-center text-brand-primary/70">
                  {error ? (
                    <div>
                      <p class="text-red-600 mb-2">Error loading people</p>
                      <p class="text-sm">{error.message}</p>
                      <p class="text-xs mt-4 text-brand-primary/50">
                        Make sure you've run the database migrations (004 and 005).
                      </p>
                    </div>
                  ) : searchQuery || tagFilter ? (
                    <div>
                      <p>No people found matching your search.</p>
                      <a href="/admin/people" class="text-brand-accent hover:underline text-sm mt-2 inline-block">
                        Clear filters
                      </a>
                    </div>
                  ) : (
                    <div>
                      <p>No people yet.</p>
                      <p class="text-sm mt-2">People will appear here when they submit forms, register for events, or make donations.</p>
                    </div>
                  )}
                </td>
              </tr>
            )}
          </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="px-6 py-4 border-t border-brand-primary/10 flex items-center justify-between">
          <div class="text-sm text-brand-primary/70">
            Page {page} of {totalPages} ({totalCount} total)
          </div>
          <div class="flex gap-2">
            {page > 1 && (
              <a 
                href={`/admin/people?page=${page - 1}${searchQuery ? `&q=${searchQuery}` : ''}${tagFilter ? `&tag=${tagFilter}` : ''}`}
                class="px-4 py-2 border border-brand-primary/20 rounded-lg text-brand-primary hover:bg-brand-light transition-colors text-sm"
              >
                Previous
              </a>
            )}
            {page < totalPages && (
              <a 
                href={`/admin/people?page=${page + 1}${searchQuery ? `&q=${searchQuery}` : ''}${tagFilter ? `&tag=${tagFilter}` : ''}`}
                class="px-4 py-2 bg-brand-primary text-white rounded-lg hover:bg-brand-dark transition-colors text-sm"
              >
                Next
              </a>
            )}
          </div>
        </div>
      )}
    </div>
  </div>
</AdminLayout>

<script>
  // Add Person Modal
  const addPersonBtn = document.getElementById('add-person-btn');
  const addPersonModal = document.getElementById('add-person-modal');
  const addPersonForm = document.getElementById('add-person-form');
  const closeAddPersonModal = document.getElementById('close-add-person-modal');
  const cancelAddPerson = document.getElementById('cancel-add-person');
  const addPersonMessage = document.getElementById('add-person-message');

  if (addPersonBtn && addPersonModal) {
    addPersonBtn.addEventListener('click', () => {
      addPersonModal.classList.remove('hidden');
    });
  }

  if (closeAddPersonModal && addPersonModal) {
    closeAddPersonModal.addEventListener('click', () => {
      addPersonModal.classList.add('hidden');
      if (addPersonForm) addPersonForm.reset();
      if (addPersonMessage) {
        addPersonMessage.classList.add('hidden');
        addPersonMessage.textContent = '';
      }
    });
  }

  if (cancelAddPerson && addPersonModal) {
    cancelAddPerson.addEventListener('click', () => {
      addPersonModal.classList.add('hidden');
      if (addPersonForm) addPersonForm.reset();
      if (addPersonMessage) {
        addPersonMessage.classList.add('hidden');
        addPersonMessage.textContent = '';
      }
    });
  }

  // Close modal on outside click
  if (addPersonModal) {
    addPersonModal.addEventListener('click', (e) => {
      if (e.target === addPersonModal) {
        addPersonModal.classList.add('hidden');
        if (addPersonForm) addPersonForm.reset();
      }
    });
  }

  // Add Person Form Submission
  if (addPersonForm) {
    addPersonForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(addPersonForm);
      const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone') || null,
        personType: formData.get('personType'),
        organization: formData.get('organization') || null,
      };

      const submitBtn = addPersonForm.querySelector('button[type="submit"]') as HTMLButtonElement;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding...';

      try {
        const response = await fetch('/api/admin/add-person', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();
        
        if (response.ok) {
          addPersonMessage.className = 'mt-4 p-4 rounded-xl text-center bg-green-50 text-green-700 border border-green-200';
          addPersonMessage.textContent = 'Person added successfully! Page will refresh...';
          addPersonMessage.classList.remove('hidden');
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          addPersonMessage.className = 'mt-4 p-4 rounded-xl text-center bg-red-50 text-red-700 border border-red-200';
          addPersonMessage.textContent = result.error || 'Failed to add person';
          addPersonMessage.classList.remove('hidden');
        }
      } catch (error: any) {
        addPersonMessage.className = 'mt-4 p-4 rounded-xl text-center bg-red-50 text-red-700 border border-red-200';
        addPersonMessage.textContent = 'Network error: ' + error.message;
        addPersonMessage.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Person';
      }
    });
  }

  // Delete Person Function
  function deletePerson(personId: string, personName: string) {
    if (!confirm(`Are you sure you want to delete ${personName}? This action cannot be undone.`)) {
      return;
    }

    fetch(`/api/admin/delete-person?id=${personId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Show success message briefly, then reload
          const message = document.createElement('div');
          message.className = 'fixed top-4 right-4 bg-green-50 text-green-700 px-6 py-3 rounded-xl shadow-lg border border-green-200 z-50';
          message.textContent = data.message || 'Person deleted successfully';
          document.body.appendChild(message);
          
          setTimeout(() => {
            message.remove();
            window.location.reload();
          }, 1500);
        } else {
          alert('Error: ' + (data.error || 'Failed to delete person'));
        }
      })
      .catch(error => {
        console.error('Delete error:', error);
        alert('Network error: ' + error.message);
      });
  }

  (window as any).deletePerson = deletePerson;
</script>
